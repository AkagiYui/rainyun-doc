---
slug: rainyun-with-opensource-1
title: 开源软件构筑雨云-技术设施篇
authors: linyu
tags: [技术干货]
---

雨云和开源软件的关系密不可分。本系列分享想和大家分享一下雨云是怎样使用众多开源软件来构建我们的云平台的。

我们定义的基础设施包括运行云平台的底层应用，例如虚拟化环境、备份系统、存储系统、容器环境等，其他的上层应用都构建在基础设施上面，来看看有哪些，雨云和他们又有什么故事呢。

<!--truncate-->
本期介绍的雨云所用的开源基础设施，中文描述代表他们在雨云云计算平台中的作用：

- 虚拟化环境：Proxmox VE
- 备份系统：Proxmox Backup Server
- 存储系统：TrueNAS
- 虚拟主机：LXD
- 容器环境：K3S

## 虚拟化环境：Proxmox VE

![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/a3cf46342b09b181c86688a1967f0ea2.png)

### 简介
Proxmox Virtual Environment（简称：Proxmox VE、PVE），是一个开源的服务器虚拟化环境Linux发行版。PVE 是一个完整的企业虚拟化开源平台。通过内置的web界面，让我们可以使用单个解决方案轻松管理虚拟机和容器、软件定义的存储和网络、高可用性群集以及多种现成工具，同时还提供了完整的API。他们的第一个版本发布于2008年，历史悠久。

### 雨云的用法
雨云的云服务器运行在PVE中，对比传统的Libvirt，PVE提供美观的web网页，对于小型虚拟化环境很方便，而不需要和糟糕的XML打交道，同时也不像Ovirt一样需要多个服务器搭建主控和被控端。同时，他提供的API完整又齐全，可以让雨云的业务系统轻松对接PVE。

早期的雨云其实也有部署LXC容器作为轻量级云服务器售卖，后发现LXC容器和KVM虚拟机最好还是不要一起运行，因为发现LXC容器在不受信任的公有环境中对母机有很大影响。

PVE经常在更新，在雨云的多年实践中，从PVE5更新到PVE8，其运行稳定，坚如磐石。

国内很多人用VE代替VMware ESXI（下称ESXI），运行软路由，因为其基于Linux的Debian系统，又完全开源，可以自由安装软件、定制，这让他的可玩性比封闭的ESXI好很多。如果您想构建一个HomeLab，PVE也是一个很好的选择，他轻量化、不会占用很多资源。

![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/835d4b7e07e458a926179db7a047bf89.png)

## 备份系统：Proxmox Backup Server

### 简介
Proxmox Backup Server（简称：PBS） 是一种企业备份解决方案，用于备份和恢复虚拟机、容器和物理主机。通过支持增量、完全重复数据删除的备份，Proxmox Backup Server 显着降低了网络负载并节省了宝贵的存储空间。凭借强大的加密和确保数据完整性的方法，您在备份数据时可以感到安全，即使是备份到不完全信任的目标。

### 雨云的用法
雨云从2019年开始使用PBS，所有云服务器的备份功能均使用PBS实现，借助PBS，我们可以帮助用户可以快速完成服务器的备份和还原，PBS有很多亮眼的特性，包括增量备份。

### 增量备份

增量的备份的意思是第一次备份一个完整的虚拟机，在后续的备份中，只备份与上一次备份中有差异的部分。

在还原时，通过合并原始数据和所要还原备份之间的磁盘差异，就可以得到当时的备份结果。这使得不必把所有数据又重新备份一遍，浪费不必要的空间。

### 重复数据删除

这个特性也非常有用，试想一下：现在有两个完全一样的虚拟机，假设每个虚拟机磁盘都是64GiB，将他们都进行一次完整备份，那得到的备份结果占用多少G空间？答案是只有64GiB，这就是重复数据删除，相同的数据只会在磁盘中存储一份，这一点结合上面的增量备份，可以把对磁盘的占用空间降低非常多，从而可以存储更多备份。

那还能不能再压缩呢？...如果增量备份+重复数据删除+数据压缩，那就更厉害了，当然有，来看看下面的存储系统：TrueNAS怎样和ZFS完美结合吧。

![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/fc59ab5d2d523e7c1567abeb1904a344.png)
（图自网络）

## 存储系统：TrueNAS

### 简介

TrueNAS是iXsystems生产的一系列免费开源网络连接存储（NAS）操作系统的品牌，基于FreeBSD和Linux，雨云使用其TrueNAS Scale版本，TrueNAS使用OpenZFS作为其底层存储系统。

### 关于ZFS
ZFS是由Sun公司（后被Oracle公司收购）开发的高级文件系统。ZFS 被称为 "终极文件系统"，稳定、快速、安全、面向未来，他支持很多特性，包括写时复制、快照、数据完整性校验和自动修复（擦除）、数据压缩、重复数据删除、RAID-Z、最大 16 Exabyte 文件大小，以及最大 256×10¹⁵ Zettabyte 存储，且对文件系统（数据集）或文件的数量没有限制。OpenZFS是ZFS文件系统和卷管理器的开源实现。

因为篇幅原因这里只抛砖引玉，有兴趣继续了解ZFS的朋友可以看看青云的这篇文章：https://zhuanlan.zhihu.com/p/413439062


### 雨云的用法

![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/3773c2291648ef89331bb6ecca06c5a6.png)

从截图也可以看出，TrueNAS已经发展出很多功能，包括虚拟化，容器功能，这让我们可以在TrueNAS上面跑很多软件。

雨云的PBS使用TrueNAS的虚拟化功能，运行与TrueNAS之上，因为ZFS有数据压缩功能，而这对于PBS来说是透明的，PBS正常写入备份数据，已经被ZFS所处理，具有了数据压缩功能。

TrueNAS有自动的定时磁盘监控检查功能，如果ZFS阵列有错误，他会提示我们更换硬盘。

我们使用的ZFS阵列具有冗余功能，以便在部分磁盘损坏的时候仍然可以给我们时间替换硬盘。

![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/e95d4f1a4d70058112e61440a57cae21.png)

在雨云的机柜中，TrueNAS的部分空间用作机柜中的计算节点备份使用，每台PVE的计算服务器都连接到了PBS，PBS运行在TrueNAS上面。

## 虚拟主机：LXD
![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/26f4ec45563b4ce526c7e0590eabeb1a.png)

### 简介
LXD是由Ubuntu开发的一个现代化、开源、安全且强大的系统容器和虚拟机管理器。

和Docker等应用级容器不同，LXD提供了一个统一的用户体验，用于在容器或虚拟机中运行和管理完整的Linux系统。

LXD支持多种Linux发行版的镜像，包括官方Ubuntu镜像和社区提供的镜像。

LXD提供了灵活的资源限制（CPU、内存、网络I/O、磁盘空间和一些内核资源），它还支持硬件直通（GPU、USB、NIC、磁盘等）LXD默认运行非特权容器，保护主机系统免受潜在攻击。

### 雨云的用法

虚拟主机是雨云的第一个产品，先从EP主机，到首创的宝塔主机，那时市面上卖的还是经过打包的宝塔面板，实际上还是EP主机的另一个套壳。

现在，雨云在各个虚拟主机节点使用LXD，为用户提供高速的一键创建部署功能。使用容器化的技术，我们降低了硬件成本，最终让利给用户，提供媲美KVM云服务器的性能。

同时实践了其资源限制机制，可以使资源在多个容器实例之间隔离，提高安全性。

其实雨云经历了混合节点到目前独立LXD节点的过程，最开始规模比较小，融合了LXC虚拟主机和云服务器，都部署在Proxmox里面，但是由于其混用导致系统不稳定，所以在后续隔离开来。

（知道这个的都是元老级用户了！😂）


## 容器环境：K3S
![](https://rainyun-assets.cn-sy1.s3.rainyun.cn/2023/09/0eb6c15434c7c761f0b56b4c0eb9f952.png)

### 简介
K3S是由`Rancher Labs`开发的一个轻量级的 Kubernetes 发行版，它针对边缘计算、物联网等场景进行了高度优化。K3s 包括但不限于以下功能：
- 打包为单个二进制文件。
- 使用基于 sqlite3 的轻量级存储后端作为默认存储机制。
- 封装在简单的启动程序中，通过该启动程序处理很多复杂的 TLS 和选项。

有兴趣的朋友可以到他们的中文官网：https://docs.rancher.cn/ 进一步了解。

### 雨云的用法

现在我们使用K3S部署主要的前后端服务，借助K8S的特性，我们实现了滚动更新的功能，为用户提供稳定的服务。

在雨云主站的前后端开发中，借助CI（持续集成）和CD（持续部署），开发好的版本会自动编译、测试并自动部署到K3S集群。

集群会等待旧版本完成服务后再部署启动新的服务， 这就使得更新不会导致服务中断，这就是我们说的`rolling update（滚动更新）`

## 结语

各种开源软件在各个关键位置支撑着雨云和广大用户，没有各种开源软件的支持，就没有雨云，同时真诚感谢开源社区的辛苦工作。

同时我们希望随着雨云的发展，能够反哺开源社区，为广大用户带来好用的开源软件。